# ROS Driver

The ROS Driver node exposes Stellar sensor streams to ROS.

# Install and uninstall deptrum-ros-driver debian pakage
- `sudo dpkg -i ros-[ROS_DISTRO]-deptrum-ros-driver-stellar420_[version]-0[Ubuntu DISTRIB_CODENAME]_amd64.deb` : Install deptrum-ros-driver
- `sudo dpkg --purge ros-[ROS_DISTRO]-deptrum-ros-driver-stellar420`: Uninstall deptrum-ros-driver-stellar420
## Set Environment Variable
  If multiple devices are installed, in order to prevent chaos caused by communication between nodes in the local area network, different environment variables must be set for each device,for example `export ROS_DOMAIN_ID=5`
## Launch Ros Driver Node

After the Ros Driver is installed, first you must use `source /opt/ros/[ROS_DISTRO]/setup.bash`, you can run this to launch the ros driver: `ros2 launch deptrum-ros-driver-stellar420 stellar420_launch.py`

To set parameters, can modify launch file

 - `depth_enable ` (default=`true`) : Enable or disable the depth frame
 - `ir_enable ` (default=`true`) : Enable or disable the ir frame
 - `rgb_enable ` (default=`true`) : Enable or disable the rgb frame
 - `point_cloud_enable ` (default=`true`) : Generate a point cloud from depth data. Requires depth_enable
 - `rgb_fps ` (default=`25`) : FPS to run rgb cameras at. Valid options are 5, 10,15,20 and 25
 - `ir_fps ` (default=`25`) : FPS to run ir cameras at. Valid options are 5, 10,15,20 and 25
 - `usb_port_number` (default=``) : The device is created through USB port number,  you can set with usb port number;
 - `outlier_point_removal_flag` (default=`true`) : enable or disable outlier point removal,  the default setting is enable;
 - `rgbd_enable` (default=`false`): Enable or disable the rgbd frame, if rgbd mode enable, the depth frame，rgb frame， ir frame， point cloud get from rgbd frame
 - `exposure_enable`(default=`false`):  Enable or disable to set camera exposure time
 - `exposure_time`(default=`1000`):  Set the exposure time for the camera(not set `exposure_enable` default AE)
 - `resolution_mode_index`(default=`0`):  Set Mode resolution index default `0`
 - `undistortion_enable`(default=`false`): Enable or disable the undistortion
 - `filter_type`(default=`1`): Set the way for filtering 0-fast 1-mean
 - `depth_frequency_fusion_threshold`(default=`120.0`): Set the threshold of depth for frequency fusion,range in [0, 7500]
 - `ir_frequency_fusion_threshold`(default=`24`): Set the threshold of ir for frequency fusion, fusion,range in [0, 4095]
 - `ratio_scatter_filter_threshold`(default=`0.025`): Set the ratio of distance percentage threshold for scatter filtering  ratio in [0.01,0.3]
 - `heart_enable`(default=`true`): Enable or disable  open heart to reboot device when camerasdk detach firmware 
 - `update_file_path` (default=``) : Set Upgrade path of .img, after firmware upgrade succeed,reset it '',Otherwise reboot ros-driver will be failed ;
 - `log_dir` (default=`/tmp`) : The log path storage ;
 - `heart_timeout_times (default=8)`: Heart time out times
 - `stream_sdk_log_enable (default=true)`: Open StreamSdk log enable

## Topics

The node emits a variety of topics into its namespace.

- `depth/image_raw` (`sensor_msgs::Image`) : The raw image from the depth camera, in 16UC1 format. 
- `rgb/image_raw` (`sensor_msgs::Image`) : The raw image from the color camera, in BGR888 format. 
- `ir/image_raw` (`sensor_msgs::Image`) : The raw infrared image from the ir camera sensor. 
- `points2` (`sensor_msgs::PointCloud2`) : The point cloud generated by the Stelalr SDK from the depth camera data. 
- `rgb/camera_info` (`sensor_msgs::CameraInfo`) : Calibration information for the color camera, converted from Stellar SDK format. 
- `ir/camera_info` (`sensor_msgs::CameraInfo`) : Calibration information for the ir camera, converted from Stellar SDK format.
- `camera_version` (`std_msgs/String`) : The information of version,format is `stream_sdk_version,device_name,serial_num,tof_firmware_version,rgb_firmware_version`. 

## Visualization on rviz

Use rviz to visualize stellar topics mesages: `ros2 run rviz2 rviz2`

Set [Global Options] -> [Fixed Frame] = `depth_camera_link`

Add [By topic] -> /depth/image_raw/image
               -> /ir/image_raw/image
               -> /rgb/image_raw/image
               -> /points2/PointCloud2

## Visualization on rviz config

Use rviz to visualize stellar topics mesages: `ros2 launch deptrum-ros-driver-stellar420 viewer420_launch.py`

Set [Displays] -> [ir] = `enable`
Set [Displays] -> [depth] = `enable`
Set [Displays] -> [rgb] = `enable`

## Log
Log information is stored in the/tmp directory,You can view the latest logs through the soft link `/tmp/node.INFO`,the log file format
is `deptrum_ros_driver_*`

